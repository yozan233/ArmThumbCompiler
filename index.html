<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASM THUMB 编译器</title>
    <link id="favicon" rel="shortcut icon" href="./img/favicon.webp" type="image/x-icon">
<style>
    * { 
        padding: 0; 
        margin: 0;
        box-sizing: border-box;
    }
    body {
        padding: 10px;
    }
    #et_code {
        flex: 1;
        margin: 0;
        padding: 6px 8px;
        font-family: monospace;
        font-size: 13px;
        line-height: 1.2;
        border: 0;
        outline: none;
        resize: none;
        overflow: auto;
        white-space: pre;
        word-wrap: normal;
        overflow-wrap: normal;
    }
    .editor-wrapper {
        display: flex;
        border: 1px solid #ccc;
        height: 45vh;
        overflow: hidden;
        flex: 1;
        margin-right: 10px;
    }
    .gutter {
        width: 3.2em;
        background: #f5f5f5;
        color: #666;
        text-align: right;
        padding: 6px 8px;
        font-family: monospace;
        font-size: 13px;
        line-height: 1.2;
        overflow: hidden;
        white-space: pre;
    }
    #et_result {
        width: 98%;
        height: 30vh;
        margin-top: 10px;
        padding: 5px;
        outline-style: none;
        border-width: 0px;
        background-color: #eee;
    }
    button {
        width: 80px;
        height: 40px;
    }

</style>
</head>
<body>
    <h3>ASM THUMB 编译器</h3>

    <div style="display: flex;margin-top: 10px;">
        <div class="editor-wrapper">
            <div class="gutter" id="gutter">1</div>
            <textarea id="et_code" spellcheck="false" wrap="off"></textarea>
        </div>
        <div>
            <button id="btn_assemble">编译</button>
            <br>
            <br>
            <button id="btn_download">下载</button>
        </div>
    </div>

    <textarea id="et_result" readonly></textarea>

</body>

<script data-main="js/main" src="./js/require.js" async></script>
<link id="lk-as-js" rel="preload" href="./js/arm-none-eabi-as.js" as="script">
<link id="lk-objcopy-js" rel="preload" href="./js/arm-none-eabi-objcopy.js" as="script">
<link id="lk-as-wasm" rel="preload" href="./js/as.wasm" as="script">
<link id="lk-objcopy-wasm" rel="preload" href="./js/objcopy.wasm" as="script">

<script>
let etCode = document.getElementById("et_code");
let gutter = document.getElementById("gutter");
let etResult = document.getElementById("et_result");

let onWasmLoadedPostRun = null;

function updateGutter() {
    const codeText = etCode.value;
    localStorage.setItem("asthumn_asm_code", codeText);
    const normalized = codeText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    const lines = normalized.split('\n').length;
    let s = '';
    for (let i = 1; i <= lines; i++) s += i + '\n';
    gutter.textContent = s;
}
etCode.addEventListener('input', updateGutter);
etCode.addEventListener('scroll', () => { gutter.scrollTop = etCode.scrollTop; });

const editor = {
    getValue: () => etCode.value,
    setValue: (v) => { etCode.value = v; updateGutter(); }
};

const initialCode = 
`.text
.align 2
.thumb
.thumb_func
push {lr}
mov r0, #1
pop {pc}
`
let localCode = localStorage.getItem("asthumn_asm_code");

editor.setValue(localCode || initialCode);

const etResultResizeObserver = new ResizeObserver(entries => {
    const entry = entries[0];
    const width = entry.contentRect.width;
    let fontSize = (width-10) / 28;
    if(fontSize < 8) 
        fontSize = 8;
    else if(fontSize > 18)
        fontSize = 18;
    entry.target.style.fontSize = fontSize + 'px';
});
etResultResizeObserver.observe(etResult);

const linkElements = [
    document.getElementById("lk-as-js"),
    document.getElementById("lk-objcopy-js"),
    document.getElementById("lk-as-wasm"),
    document.getElementById("lk-objcopy-wasm"),
];

function linkElementOnload(el){
    el.isLoadComplete = true;
    if(isCoreLoade()){
        const onPostRun = onWasmLoadedPostRun;
        if(onPostRun){
            onWasmLoadedPostRun = null;
            onPostRun();
        }
    }
}

linkElements.forEach(el=>{
    el.onload = function(){ linkElementOnload(el) }
});

function isCoreLoade(){
    for(let i=0;i<linkElements.length;i++){
        const el = linkElements[i];
        if(el.isLoadComplete)
            continue;
        const entries = performance.getEntriesByName(el.href);
        if(!entries || entries.length == 0){
            return false;
        }
    }
    return true;
}

async function doAssembleThumb(codeText){
    if(typeof assembleThumb !== 'function'){
        const t = setInterval(() => {
            if(typeof assembleThumb === 'function'){
                clearInterval(t);
                doAssembleThumb(codeText);
            }
        },500);
        return;
    }

    let filename = `asm_${new Date().getTime().toString(16)}`;

    try {
        let u8Array = await assembleThumb(codeText,filename);

        let hexString = '';
        for (let i = 0; i < u8Array.length; i++) {
            hexString += u8Array[i].toString(16).toUpperCase().padStart(2, '0');
            if(i != u8Array.length - 1){
                if ((i + 1) % 16 === 0) {
                    hexString += '\n';
                } else {
                    hexString += ' ';
                }
            }
        }

        etResult.value = hexString;
        
        saveResultBin(u8Array);
            

    } catch (e) {
        let msg = e && e.message ? e.message : e;

        msg = msg.replaceAll(`${filename}.`,'');

        etResult.value = msg;

        window.resultBin = null;
    }

}

function saveResultBin(u8Array){
    // 保证是 Uint8Array
    let u8 = u8Array;
    if (!(u8 instanceof Uint8Array)) {
        if (Array.isArray(u8)) {
            u8 = Uint8Array.from(u8);
        } else if (u8 && u8.buffer) {
            u8 = new Uint8Array(u8.buffer, u8.byteOffset || 0, u8.byteLength || u8.length || 0);
        } else {
            u8 = Uint8Array.from(u8);
        }
    }
    window.resultBin = u8;
}

document.getElementById("btn_assemble").onclick = async function() {
    let codeText = editor.getValue();
    if(codeText.trim().length == 0){
        toast("代码不能为空！");
        return;
    }

    if(etResult.value == "编译中..."){
        toast("正在编译中，请稍后...");
        return;
    }

    etResult.value = "编译中...";

    if(isCoreLoade()){
        doAssembleThumb(codeText);
    }
    else{
        onWasmLoadedPostRun = function(){
            doAssembleThumb(codeText);
        };
    }

};

document.getElementById("btn_download").onclick = function() {
    if(window.resultUrl){
        URL.revokeObjectURL(window.resultUrl);
        window.resultUrl = null;
    }
    if(!window.resultBin){
        toast("代码未编译成功，无法下载！");
        return;
    }
    const blob = new Blob([window.resultBin], { type: 'application/octet-stream' });
    const url = URL.createObjectURL(blob);
    window.resultUrl = url;
    const a = document.createElement('a');
    a.href = url;
    a.download = 'output.bin';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    //URL.revokeObjectURL(url);
};

function toast(msg){
    if(window.tools){
        if(window.tools.android){
            window.tools.android.toast(msg);
            return;
        }
    }
    alert(msg);
}

</script>
</html>